{% extends 'base.html' %}

{% block title %}Nueva Entrada de Compra - Inventario{% endblock %}

{% block content %}
<div class="space-y-6">
    <div class="flex justify-between items-center">
        <h1 class="text-3xl font-bold text-gray-800">
            <i class="fas fa-arrow-down mr-2 text-blue-500"></i>Nueva Entrada de Compra
        </h1>
        <a href="{% url 'inventario:entradas' %}" class="text-gray-600 hover:text-gray-800">
            <i class="fas fa-arrow-left mr-2"></i>Volver
        </a>
    </div>
    
    <form method="post" id="entradaForm">
        {% csrf_token %}
        
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Columna Izquierda: Información de la Entrada -->
            <div class="lg:col-span-1 space-y-6">
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h2 class="text-xl font-bold text-gray-800 mb-4">
                        <i class="fas fa-info-circle mr-2 text-blue-500"></i>Información de la Compra
                    </h2>
                    
                    <div class="mb-4">
                        <label for="{{ form.numero_factura.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                            {{ form.numero_factura.label }} <span class="text-red-500">*</span>
                        </label>
                        {{ form.numero_factura }}
                    </div>
                    
                    <div class="mb-4">
                        <label for="{{ form.proveedor.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                            {{ form.proveedor.label }} <span class="text-red-500">*</span>
                        </label>
                        {{ form.proveedor }}
                    </div>
                    
                    <div class="mb-4">
                        <label for="{{ form.fecha_compra.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                            {{ form.fecha_compra.label }} <span class="text-red-500">*</span>
                        </label>
                        {{ form.fecha_compra }}
                    </div>
                    
                    <div class="mb-4">
                        <label for="{{ form.observaciones.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                            {{ form.observaciones.label }}
                        </label>
                        {{ form.observaciones }}
                    </div>
                </div>
                
                <!-- Resumen -->
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h2 class="text-xl font-bold text-gray-800 mb-4">
                        <i class="fas fa-calculator mr-2 text-green-500"></i>Resumen
                    </h2>
                    <div class="space-y-3">
                        <div>
                            <p class="text-sm text-gray-500 mb-1">Proveedor:</p>
                            <p class="font-semibold text-gray-800" id="proveedorNombre">-</p>
                        </div>
                        <div class="flex justify-between pt-2 border-t">
                            <span class="text-gray-600">Total:</span>
                            <span class="text-lg font-bold text-gray-800" id="total">C$ 0.00</span>
                        </div>
                        <div class="text-sm text-gray-500">
                            <p id="cantidadProductos">0 productos</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Columna Derecha: Productos -->
            <div class="lg:col-span-2 space-y-6">
                <!-- Agregar Producto -->
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h2 class="text-xl font-bold text-gray-800 mb-4">
                        <i class="fas fa-plus-circle mr-2 text-green-500"></i>Agregar Producto
                    </h2>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Producto</label>
                            <div class="relative">
                                <input type="text" id="productoSearch" 
                                       placeholder="Buscar producto por nombre..."
                                       class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                       autocomplete="off">
                                <div id="productoDropdown" class="hidden absolute z-50 w-full mt-1 bg-white border border-gray-300 rounded-lg shadow-lg max-h-60 overflow-auto">
                                    <!-- Se llenará dinámicamente -->
                                </div>
                            </div>
                            <select id="productoSelect" class="hidden">
                                <option value="">-- Seleccionar producto --</option>
                                {% for producto in productos %}
                                <option value="{{ producto.id }}" 
                                        data-precio="{{ producto.precio_compra }}"
                                        data-costo-promedio="{{ producto.costo_promedio }}"
                                        data-nombre="{{ producto.nombre }}"
                                        data-unidad="{{ producto.unidad_medida }}">
                                    {{ producto.nombre }}
                                </option>
                                {% endfor %}
                            </select>
                            <input type="hidden" id="productoIdSeleccionado" value="">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Cantidad</label>
                            <input type="number" id="cantidadInput" min="1" value="1"
                                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Precio Unit. (C$)</label>
                            <input type="number" id="precioInput" step="0.01" min="0"
                                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                   placeholder="0.00">
                            <p class="text-xs text-gray-500 mt-1" id="precioSugerido"></p>
                        </div>
                    </div>
                    <div class="mt-4">
                        <button type="button" id="agregarProductoBtn" 
                                class="w-full bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-4 rounded-lg transition">
                            <i class="fas fa-plus mr-2"></i>Agregar Producto
                        </button>
                    </div>
                </div>
                
                <!-- Lista de Productos -->
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h2 class="text-xl font-bold text-gray-800 mb-4">
                        <i class="fas fa-shopping-cart mr-2 text-blue-500"></i>Productos Agregados
                    </h2>
                    
                    <div id="productosLista" class="space-y-3">
                        <p class="text-gray-500 text-center py-4">No hay productos agregados</p>
                    </div>
                    
                    <input type="hidden" name="productos" id="productosJson" value="[]">
                </div>
                
                <!-- Botones de Acción -->
                <div class="flex justify-end space-x-4">
                    <a href="{% url 'inventario:entradas' %}" 
                       class="bg-gray-500 hover:bg-gray-600 text-white font-semibold py-3 px-6 rounded-lg transition">
                        <i class="fas fa-times mr-2"></i>Cancelar
                    </a>
                    <button type="submit" 
                            class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-3 px-6 rounded-lg transition">
                        <i class="fas fa-save mr-2"></i>Registrar Entrada
                    </button>
                </div>
            </div>
        </div>
    </form>
</div>

<script>
let productosAgregados = [];

function actualizarResumen() {
    let total = 0;
    let totalCantidad = 0;
    productosAgregados.forEach(item => {
        if (!item.editing) {
            total += item.precio * item.cantidad;
            totalCantidad += item.cantidad;
        }
    });
    
    document.getElementById('total').textContent = 'C$ ' + total.toFixed(2);
    document.getElementById('cantidadProductos').textContent = productosAgregados.length + ' productos (' + totalCantidad + ' unidades)';
}

function renderizarProductos() {
    const lista = document.getElementById('productosLista');
    const inputJson = document.getElementById('productosJson');
    
    if (productosAgregados.length === 0) {
        lista.innerHTML = '<p class="text-gray-500 text-center py-4">No hay productos agregados</p>';
        inputJson.value = '[]';
        return;
    }
    
    let html = '<div class="overflow-x-auto"><table class="min-w-full divide-y divide-gray-200"><thead class="bg-gray-50"><tr>';
    html += '<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Producto</th>';
    html += '<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Cantidad</th>';
    html += '<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Precio Unit.</th>';
    html += '<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Subtotal</th>';
    html += '<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Acción</th>';
    html += '</tr></thead><tbody class="divide-y divide-gray-200">';
    
    productosAgregados.forEach((item, index) => {
        const subtotal = item.precio * item.cantidad;
        const isEditing = item.editing || false;
        
        if (isEditing) {
            // Modo edición
            html += `<tr class="bg-blue-50">
                <td class="px-4 py-3 text-sm text-gray-900">
                    <div class="font-medium">${item.nombre}</div>
                    <div class="text-xs text-gray-500">${item.unidad || ''}</div>
                </td>
                <td class="px-4 py-3 text-sm">
                    <input type="number" id="editCantidad_${index}" 
                           value="${item.cantidad}" min="1"
                           class="w-20 px-2 py-1 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500">
                </td>
                <td class="px-4 py-3 text-sm">
                    <input type="number" id="editPrecio_${index}" 
                           value="${item.precio.toFixed(2)}" step="0.01" min="0"
                           class="w-24 px-2 py-1 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500">
                </td>
                <td class="px-4 py-3 text-sm font-semibold text-gray-900">
                    <span id="subtotal_${index}">C$ ${subtotal.toFixed(2)}</span>
                </td>
                <td class="px-4 py-3 text-sm">
                    <div class="flex space-x-2">
                        <button type="button" onclick="guardarEdicion(${index})" 
                                class="text-green-600 hover:text-green-800" title="Guardar">
                            <i class="fas fa-check"></i>
                        </button>
                        <button type="button" onclick="cancelarEdicion(${index})" 
                                class="text-gray-600 hover:text-gray-800" title="Cancelar">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </td>
            </tr>`;
        } else {
            // Modo visualización
            html += `<tr>
                <td class="px-4 py-3 text-sm text-gray-900">
                    <div class="font-medium">${item.nombre}</div>
                    <div class="text-xs text-gray-500">${item.unidad || ''}</div>
                </td>
                <td class="px-4 py-3 text-sm text-gray-600">${item.cantidad}</td>
                <td class="px-4 py-3 text-sm text-gray-600">C$ ${item.precio.toFixed(2)}</td>
                <td class="px-4 py-3 text-sm font-semibold text-gray-900">C$ ${subtotal.toFixed(2)}</td>
                <td class="px-4 py-3 text-sm">
                    <div class="flex space-x-2">
                        <button type="button" onclick="editarProducto(${index})" 
                                class="text-blue-600 hover:text-blue-800" title="Editar">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button type="button" onclick="eliminarProducto(${index})" 
                                class="text-red-600 hover:text-red-800" title="Eliminar">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </td>
            </tr>`;
        }
    });
    
    html += '</tbody></table></div>';
    lista.innerHTML = html;
    inputJson.value = JSON.stringify(productosAgregados.map(item => ({
        producto_id: item.producto_id,
        nombre: item.nombre,
        unidad: item.unidad,
        cantidad: item.cantidad,
        precio: item.precio,
        precio_unitario: item.precio_unitario || item.precio
    })));
    
    // Agregar event listeners para edición en tiempo real
    setTimeout(() => {
        agregarEventListenersEdicion();
    }, 100);
}

// Búsqueda de productos
const productoSelect = document.getElementById('productoSelect');
const productoSearch = document.getElementById('productoSearch');
const productoDropdown = document.getElementById('productoDropdown');
const productoIdSeleccionado = document.getElementById('productoIdSeleccionado');
const precioInput = document.getElementById('precioInput');
const precioSugerido = document.getElementById('precioSugerido');

productoSearch.addEventListener('input', function() {
    const searchTerm = this.value.toLowerCase();
    const options = productoSelect.querySelectorAll('option');
    
    if (searchTerm.length === 0) {
        productoDropdown.classList.add('hidden');
        productoIdSeleccionado.value = '';
        precioInput.value = '';
        precioSugerido.textContent = '';
        return;
    }
    
    let html = '';
    let count = 0;
    
    options.forEach(option => {
        if (option.value && option.textContent.toLowerCase().includes(searchTerm)) {
            html += `<div class="px-4 py-2 hover:bg-blue-50 cursor-pointer border-b border-gray-100" 
                         data-producto-id="${option.value}"
                         data-precio="${option.dataset.precio}"
                         data-costo-promedio="${option.dataset.costoPromedio}"
                         data-nombre="${option.dataset.nombre}"
                         data-unidad="${option.dataset.unidad}">
                    <div class="font-medium text-gray-900">${option.dataset.nombre}</div>
                    <div class="text-xs text-gray-500">Costo promedio: C$ ${parseFloat(option.dataset.costoPromedio || option.dataset.precio || 0).toFixed(2)}</div>
                </div>`;
            count++;
        }
    });
    
    if (count > 0) {
        productoDropdown.innerHTML = html;
        productoDropdown.classList.remove('hidden');
        
        // Agregar eventos a los items del dropdown
        productoDropdown.querySelectorAll('div[data-producto-id]').forEach(item => {
            item.addEventListener('click', function() {
                const productoId = this.dataset.productoId;
                const nombre = this.dataset.nombre;
                const precio = this.dataset.precio;
                const costoPromedio = this.dataset.costoPromedio;
                const unidad = this.dataset.unidad;
                
                productoSearch.value = nombre;
                productoIdSeleccionado.value = productoId;
                precioInput.value = precio || costoPromedio || '';
                precioSugerido.textContent = costoPromedio && parseFloat(costoPromedio) > 0 
                    ? `Costo promedio: C$ ${parseFloat(costoPromedio).toFixed(2)}` 
                    : '';
                productoDropdown.classList.add('hidden');
            });
        });
    } else {
        productoDropdown.classList.add('hidden');
    }
});

// Cerrar dropdown al hacer click fuera
document.addEventListener('click', function(e) {
    if (!productoSearch.contains(e.target) && !productoDropdown.contains(e.target)) {
        productoDropdown.classList.add('hidden');
    }
});

document.getElementById('agregarProductoBtn').addEventListener('click', function() {
    const cantidadInput = document.getElementById('cantidadInput');
    
    const productoId = productoIdSeleccionado.value;
    const cantidad = parseInt(cantidadInput.value) || 1;
    const precio = parseFloat(precioInput.value) || 0;
    
    if (!productoId) {
        alert('Por favor seleccione un producto');
        return;
    }
    
    if (precio <= 0) {
        alert('El precio debe ser mayor a cero');
        return;
    }
    
    // Obtener información del producto seleccionado
    const option = productoSelect.querySelector(`option[value="${productoId}"]`);
    if (!option) {
        alert('Producto no encontrado');
        return;
    }
    
    const nombre = option.dataset.nombre;
    const unidad = option.dataset.unidad;
    
    productosAgregados.push({
        producto_id: productoId,
        nombre: nombre,
        unidad: unidad,
        cantidad: cantidad,
        precio: precio,
        precio_unitario: precio,  // Para compatibilidad con el backend
        editing: false
    });
    
    renderizarProductos();
    actualizarResumen();
    
    // Limpiar formulario pero mantener el producto seleccionado
    cantidadInput.value = 1;
    precioInput.value = '';
    precioSugerido.textContent = '';
    // No limpiar el producto para poder agregarlo varias veces
});

function editarProducto(index) {
    // Marcar el producto como en edición
    productosAgregados[index].editing = true;
    renderizarProductos();
}

function actualizarSubtotalEdicion(index) {
    const cantidadInput = document.getElementById(`editCantidad_${index}`);
    const precioInput = document.getElementById(`editPrecio_${index}`);
    const subtotalSpan = document.getElementById(`subtotal_${index}`);
    
    if (cantidadInput && precioInput && subtotalSpan) {
        const cantidad = parseFloat(cantidadInput.value) || 0;
        const precio = parseFloat(precioInput.value) || 0;
        const subtotal = cantidad * precio;
        subtotalSpan.textContent = 'C$ ' + subtotal.toFixed(2);
    }
}

function guardarEdicion(index) {
    const cantidadInput = document.getElementById(`editCantidad_${index}`);
    const precioInput = document.getElementById(`editPrecio_${index}`);
    
    const nuevaCantidad = parseInt(cantidadInput.value) || 1;
    const nuevoPrecio = parseFloat(precioInput.value) || 0;
    
    if (nuevaCantidad <= 0) {
        alert('La cantidad debe ser mayor a cero');
        return;
    }
    
    if (nuevoPrecio <= 0) {
        alert('El precio debe ser mayor a cero');
        return;
    }
    
    // Actualizar el producto
    productosAgregados[index].cantidad = nuevaCantidad;
    productosAgregados[index].precio = nuevoPrecio;
    productosAgregados[index].precio_unitario = nuevoPrecio;
    productosAgregados[index].editing = false;
    
    renderizarProductos();
    actualizarResumen();
}

// Agregar event listeners después de renderizar para actualizar subtotal en tiempo real
function agregarEventListenersEdicion() {
    productosAgregados.forEach((item, index) => {
        if (item.editing) {
            const cantidadInput = document.getElementById(`editCantidad_${index}`);
            const precioInput = document.getElementById(`editPrecio_${index}`);
            
            if (cantidadInput) {
                cantidadInput.addEventListener('input', () => actualizarSubtotalEdicion(index));
            }
            if (precioInput) {
                precioInput.addEventListener('input', () => actualizarSubtotalEdicion(index));
            }
        }
    });
}

function cancelarEdicion(index) {
    // Cancelar edición sin guardar cambios
    productosAgregados[index].editing = false;
    renderizarProductos();
}

function eliminarProducto(index) {
    if (confirm('¿Está seguro de eliminar este producto de la lista?')) {
        productosAgregados.splice(index, 1);
        renderizarProductos();
        actualizarResumen();
    }
}

// Mostrar proveedor en el resumen
document.getElementById('id_proveedor').addEventListener('input', function() {
    const proveedorNombre = document.getElementById('proveedorNombre');
    proveedorNombre.textContent = this.value || '-';
});

// Inicializar proveedor si ya tiene valor
document.addEventListener('DOMContentLoaded', function() {
    const proveedorInput = document.getElementById('id_proveedor');
    if (proveedorInput && proveedorInput.value) {
        document.getElementById('proveedorNombre').textContent = proveedorInput.value;
    }
});

document.getElementById('entradaForm').addEventListener('submit', function(e) {
    if (productosAgregados.length === 0) {
        e.preventDefault();
        alert('Debe agregar al menos un producto a la entrada');
        return false;
    }
});
</script>
{% endblock %}
