{% extends 'base.html' %}

{% block title %}Nueva Entrada de Compra - Inventario{% endblock %}

{% block content %}
<div class="space-y-6">
    <div class="flex justify-between items-center">
        <h1 class="text-3xl font-bold text-gray-800">
            <i class="fas fa-arrow-down mr-2 text-blue-500"></i>Nueva Entrada de Compra
        </h1>
        <a href="{% url 'inventario:entradas' %}" class="text-gray-600 hover:text-gray-800">
            <i class="fas fa-arrow-left mr-2"></i>Volver
        </a>
    </div>
    
    <form method="post" id="entradaForm">
        {% csrf_token %}
        
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Columna Izquierda: Informaci贸n de la Entrada -->
            <div class="lg:col-span-1 space-y-6">
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h2 class="text-xl font-bold text-gray-800 mb-4">
                        <i class="fas fa-info-circle mr-2 text-blue-500"></i>Informaci贸n de la Compra
                    </h2>
                    
                    <div class="mb-4">
                        <label for="{{ form.numero_factura.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                            {{ form.numero_factura.label }} <span class="text-red-500">*</span>
                        </label>
                        {{ form.numero_factura }}
                    </div>
                    
                    <div class="mb-4">
                        <label for="{{ form.proveedor.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                            {{ form.proveedor.label }} <span class="text-red-500">*</span>
                        </label>
                        {{ form.proveedor }}
                    </div>
                    
                    <div class="mb-4">
                        <label for="{{ form.fecha_compra.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                            {{ form.fecha_compra.label }} <span class="text-red-500">*</span>
                        </label>
                        {{ form.fecha_compra }}
                    </div>
                    
                    <div class="mb-4">
                        <label for="{{ form.observaciones.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                            {{ form.observaciones.label }}
                        </label>
                        {{ form.observaciones }}
                    </div>
                </div>
                
                <!-- Resumen -->
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h2 class="text-xl font-bold text-gray-800 mb-4">
                        <i class="fas fa-calculator mr-2 text-green-500"></i>Resumen
                    </h2>
                    <div class="space-y-3">
                        <div class="flex justify-between">
                            <span class="text-gray-600">Total:</span>
                            <span class="text-lg font-bold text-gray-800" id="total">C$ 0.00</span>
                        </div>
                        <div class="text-sm text-gray-500">
                            <p id="cantidadProductos">0 productos</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Columna Derecha: Productos -->
            <div class="lg:col-span-2 space-y-6">
                <!-- Agregar Producto -->
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h2 class="text-xl font-bold text-gray-800 mb-4">
                        <i class="fas fa-plus-circle mr-2 text-green-500"></i>Agregar Producto
                    </h2>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Producto</label>
                            <select id="productoSelect" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                <option value="">-- Seleccionar producto --</option>
                                {% for producto in productos %}
                                <option value="{{ producto.id }}" 
                                        data-precio="{{ producto.precio_compra }}"
                                        data-nombre="{{ producto.nombre }}"
                                        data-unidad="{{ producto.unidad_medida }}">
                                    {{ producto.nombre }} - C$ {{ producto.precio_compra|floatformat:2 }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Cantidad</label>
                            <input type="number" id="cantidadInput" min="1" value="1"
                                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Precio Unit. (C$)</label>
                            <input type="number" id="precioInput" step="0.01" min="0"
                                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>
                    </div>
                    <div class="mt-4">
                        <button type="button" id="agregarProductoBtn" 
                                class="w-full bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-4 rounded-lg transition">
                            <i class="fas fa-plus mr-2"></i>Agregar Producto
                        </button>
                    </div>
                </div>
                
                <!-- Lista de Productos -->
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h2 class="text-xl font-bold text-gray-800 mb-4">
                        <i class="fas fa-shopping-cart mr-2 text-blue-500"></i>Productos Agregados
                    </h2>
                    
                    <div id="productosLista" class="space-y-3">
                        <p class="text-gray-500 text-center py-4">No hay productos agregados</p>
                    </div>
                    
                    <input type="hidden" name="productos" id="productosJson" value="[]">
                </div>
                
                <!-- Botones de Acci贸n -->
                <div class="flex justify-end space-x-4">
                    <a href="{% url 'inventario:entradas' %}" 
                       class="bg-gray-500 hover:bg-gray-600 text-white font-semibold py-3 px-6 rounded-lg transition">
                        <i class="fas fa-times mr-2"></i>Cancelar
                    </a>
                    <button type="submit" 
                            class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-3 px-6 rounded-lg transition">
                        <i class="fas fa-save mr-2"></i>Registrar Entrada
                    </button>
                </div>
            </div>
        </div>
    </form>
</div>

<script>
let productosAgregados = [];

function actualizarResumen() {
    let total = 0;
    productosAgregados.forEach(item => {
        total += item.precio * item.cantidad;
    });
    
    document.getElementById('total').textContent = 'C$ ' + total.toFixed(2);
    document.getElementById('cantidadProductos').textContent = productosAgregados.length + ' productos';
}

function renderizarProductos() {
    const lista = document.getElementById('productosLista');
    const inputJson = document.getElementById('productosJson');
    
    if (productosAgregados.length === 0) {
        lista.innerHTML = '<p class="text-gray-500 text-center py-4">No hay productos agregados</p>';
        inputJson.value = '[]';
        return;
    }
    
    let html = '<div class="overflow-x-auto"><table class="min-w-full divide-y divide-gray-200"><thead class="bg-gray-50"><tr>';
    html += '<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Producto</th>';
    html += '<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Cantidad</th>';
    html += '<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Precio Unit.</th>';
    html += '<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Subtotal</th>';
    html += '<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Acci贸n</th>';
    html += '</tr></thead><tbody class="divide-y divide-gray-200">';
    
    productosAgregados.forEach((item, index) => {
        const subtotal = item.precio * item.cantidad;
        html += `<tr>
            <td class="px-4 py-3 text-sm text-gray-900">${item.nombre}</td>
            <td class="px-4 py-3 text-sm text-gray-600">${item.cantidad}</td>
            <td class="px-4 py-3 text-sm text-gray-600">C$ ${item.precio.toFixed(2)}</td>
            <td class="px-4 py-3 text-sm font-semibold text-gray-900">C$ ${subtotal.toFixed(2)}</td>
            <td class="px-4 py-3 text-sm">
                <button type="button" onclick="eliminarProducto(${index})" 
                        class="text-red-600 hover:text-red-800">
                    <i class="fas fa-trash"></i>
                </button>
            </td>
        </tr>`;
    });
    
    html += '</tbody></table></div>';
    lista.innerHTML = html;
    inputJson.value = JSON.stringify(productosAgregados);
}

document.getElementById('agregarProductoBtn').addEventListener('click', function() {
    const productoSelect = document.getElementById('productoSelect');
    const cantidadInput = document.getElementById('cantidadInput');
    const precioInput = document.getElementById('precioInput');
    
    const productoId = productoSelect.value;
    const cantidad = parseInt(cantidadInput.value) || 1;
    const precio = parseFloat(precioInput.value) || 0;
    
    if (!productoId) {
        alert('Por favor seleccione un producto');
        return;
    }
    
    if (precio <= 0) {
        alert('El precio debe ser mayor a cero');
        return;
    }
    
    const option = productoSelect.options[productoSelect.selectedIndex];
    const nombre = option.dataset.nombre;
    
    productosAgregados.push({
        producto_id: productoId,
        nombre: nombre,
        cantidad: cantidad,
        precio: precio
    });
    
    renderizarProductos();
    actualizarResumen();
    
    productoSelect.value = '';
    cantidadInput.value = 1;
    precioInput.value = '';
});

document.getElementById('productoSelect').addEventListener('change', function() {
    const option = this.options[this.selectedIndex];
    if (option.value) {
        document.getElementById('precioInput').value = option.dataset.precio || '';
    }
});

function eliminarProducto(index) {
    productosAgregados.splice(index, 1);
    renderizarProductos();
    actualizarResumen();
}

document.getElementById('entradaForm').addEventListener('submit', function(e) {
    if (productosAgregados.length === 0) {
        e.preventDefault();
        alert('Debe agregar al menos un producto a la entrada');
        return false;
    }
});
</script>
{% endblock %}
