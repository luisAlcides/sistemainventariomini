{% extends 'base.html' %}

{% block title %}Nueva Factura - Minisúper D'Pérez{% endblock %}

{% block content %}
<div class="space-y-6">
    <div class="flex justify-between items-center">
        <h1 class="text-3xl font-bold text-gray-800">
            <i class="fas fa-receipt mr-2 text-blue-500"></i>Nueva Factura
        </h1>
        <a href="{% url 'facturacion:index' %}" class="text-gray-600 hover:text-gray-800">
            <i class="fas fa-arrow-left mr-2"></i>Volver
        </a>
    </div>
    
    <form method="post" id="facturaForm">
        {% csrf_token %}
        
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Columna Izquierda: Información de la Factura -->
            <div class="lg:col-span-1 space-y-6">
                <!-- Información General -->
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h2 class="text-xl font-bold text-gray-800 mb-4">
                        <i class="fas fa-info-circle mr-2 text-blue-500"></i>Información de la Factura
                    </h2>
                    
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            Número de Factura
                        </label>
                        <input type="text" value="{{ numero_factura }}" readonly
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-gray-100 text-gray-600">
                    </div>
                    
                    <div class="mb-4">
                        <label for="{{ form.cliente.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                            Cliente Registrado (Opcional)
                        </label>
                        {{ form.cliente }}
                    </div>
                    
                    <div class="mb-4">
                        <label for="{{ form.cliente_nombre.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                            Nombre del Cliente
                        </label>
                        {{ form.cliente_nombre }}
                        <p class="text-xs text-gray-500 mt-1">Si no selecciona un cliente registrado, ingrese el nombre aquí</p>
                    </div>
                    
                    <div class="mb-4">
                        <label for="{{ form.descuento.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                            Descuento (C$)
                        </label>
                        {{ form.descuento }}
                    </div>
                    
                    <div class="mb-4">
                        <label for="{{ form.observaciones.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                            Observaciones
                        </label>
                        {{ form.observaciones }}
                    </div>
                </div>
                
                <!-- Resumen -->
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h2 class="text-xl font-bold text-gray-800 mb-4">
                        <i class="fas fa-calculator mr-2 text-green-500"></i>Resumen
                    </h2>
                    <div class="space-y-3">
                        <div class="flex justify-between">
                            <span class="text-gray-600">Subtotal:</span>
                            <span class="font-semibold text-gray-800" id="subtotal">C$ 0.00</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Descuento:</span>
                            <span class="font-semibold text-red-600" id="descuento">C$ 0.00</span>
                        </div>
                        <div class="border-t pt-3 flex justify-between">
                            <span class="text-lg font-bold text-gray-800">Total:</span>
                            <span class="text-lg font-bold text-gray-800" id="total">C$ 0.00</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Columna Derecha: Productos -->
            <div class="lg:col-span-2 space-y-6">
                <!-- Agregar Producto -->
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h2 class="text-xl font-bold text-gray-800 mb-4">
                        <i class="fas fa-plus-circle mr-2 text-green-500"></i>Agregar Producto
                    </h2>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Producto</label>
                            <select id="productoSelect" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                <option value="">-- Seleccionar producto --</option>
                                {% for producto in productos %}
                                <option value="{{ producto.id }}" 
                                        data-precio="{{ producto.precio_venta }}"
                                        data-stock="{{ producto.stock_actual }}"
                                        data-nombre="{{ producto.nombre }}">
                                    {{ producto.nombre }} - C$ {{ producto.precio_venta|floatformat:2 }} (Stock: {{ producto.stock_actual }})
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Cantidad</label>
                            <input type="number" id="cantidadInput" min="1" value="1"
                                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div class="flex items-end">
                            <button type="button" id="agregarProductoBtn" 
                                    class="w-full bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-4 rounded-lg transition">
                                <i class="fas fa-plus mr-2"></i>Agregar
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Lista de Productos -->
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h2 class="text-xl font-bold text-gray-800 mb-4">
                        <i class="fas fa-shopping-cart mr-2 text-blue-500"></i>Productos Agregados
                    </h2>
                    
                    <div id="productosLista" class="space-y-3">
                        <p class="text-gray-500 text-center py-4">No hay productos agregados</p>
                    </div>
                    
                    <!-- Input oculto para enviar productos -->
                    <input type="hidden" name="productos" id="productosJson" value="[]">
                </div>
                
                <!-- Botones de Acción -->
                <div class="flex justify-end space-x-4">
                    <a href="{% url 'facturacion:index' %}" 
                       class="bg-gray-500 hover:bg-gray-600 text-white font-semibold py-3 px-6 rounded-lg transition">
                        <i class="fas fa-times mr-2"></i>Cancelar
                    </a>
                    <button type="submit" 
                            class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-3 px-6 rounded-lg transition">
                        <i class="fas fa-save mr-2"></i>Guardar Factura
                    </button>
                </div>
            </div>
        </div>
    </form>
</div>

<script>
// Array para almacenar los productos agregados
let productosAgregados = [];

// Función para actualizar el resumen
function actualizarResumen() {
    let subtotal = 0;
    productosAgregados.forEach(item => {
        subtotal += item.precio * item.cantidad;
    });
    
    const descuento = parseFloat(document.querySelector('#id_descuento').value) || 0;
    const total = subtotal - descuento;
    
    document.getElementById('subtotal').textContent = 'C$ ' + subtotal.toFixed(2);
    document.getElementById('descuento').textContent = 'C$ ' + descuento.toFixed(2);
    document.getElementById('total').textContent = 'C$ ' + total.toFixed(2);
}

// Función para renderizar la lista de productos
function renderizarProductos() {
    const lista = document.getElementById('productosLista');
    const inputJson = document.getElementById('productosJson');
    
    if (productosAgregados.length === 0) {
        lista.innerHTML = '<p class="text-gray-500 text-center py-4">No hay productos agregados</p>';
        inputJson.value = '[]';
        return;
    }
    
    let html = '<div class="overflow-x-auto"><table class="min-w-full divide-y divide-gray-200"><thead class="bg-gray-50"><tr>';
    html += '<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Producto</th>';
    html += '<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Cantidad</th>';
    html += '<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Precio Unit.</th>';
    html += '<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Subtotal</th>';
    html += '<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Acción</th>';
    html += '</tr></thead><tbody class="divide-y divide-gray-200">';
    
    productosAgregados.forEach((item, index) => {
        const subtotal = item.precio * item.cantidad;
        html += `<tr>
            <td class="px-4 py-3 text-sm text-gray-900">${item.nombre}</td>
            <td class="px-4 py-3 text-sm text-gray-600">${item.cantidad}</td>
            <td class="px-4 py-3 text-sm text-gray-600">C$ ${item.precio.toFixed(2)}</td>
            <td class="px-4 py-3 text-sm font-semibold text-gray-900">C$ ${subtotal.toFixed(2)}</td>
            <td class="px-4 py-3 text-sm">
                <button type="button" onclick="eliminarProducto(${index})" 
                        class="text-red-600 hover:text-red-800">
                    <i class="fas fa-trash"></i>
                </button>
            </td>
        </tr>`;
    });
    
    html += '</tbody></table></div>';
    lista.innerHTML = html;
    
    // Actualizar JSON oculto
    inputJson.value = JSON.stringify(productosAgregados);
}

// Función para agregar producto
document.getElementById('agregarProductoBtn').addEventListener('click', function() {
    const productoSelect = document.getElementById('productoSelect');
    const cantidadInput = document.getElementById('cantidadInput');
    
    const productoId = productoSelect.value;
    const cantidad = parseInt(cantidadInput.value) || 1;
    
    if (!productoId) {
        alert('Por favor seleccione un producto');
        return;
    }
    
    const option = productoSelect.options[productoSelect.selectedIndex];
    const precio = parseFloat(option.dataset.precio);
    const stock = parseInt(option.dataset.stock);
    const nombre = option.dataset.nombre;
    
    if (cantidad > stock) {
        alert(`Stock insuficiente. Disponible: ${stock} unidades`);
        return;
    }
    
    // Verificar si el producto ya está agregado
    const existe = productosAgregados.findIndex(p => p.producto_id === productoId);
    if (existe !== -1) {
        // Actualizar cantidad
        productosAgregados[existe].cantidad += cantidad;
        if (productosAgregados[existe].cantidad > stock) {
            alert(`Stock insuficiente. Disponible: ${stock} unidades`);
            productosAgregados[existe].cantidad -= cantidad;
            return;
        }
    } else {
        // Agregar nuevo producto
        productosAgregados.push({
            producto_id: productoId,
            nombre: nombre,
            cantidad: cantidad,
            precio: precio
        });
    }
    
    renderizarProductos();
    actualizarResumen();
    
    // Limpiar campos
    productoSelect.value = '';
    cantidadInput.value = 1;
});

// Función para eliminar producto
function eliminarProducto(index) {
    productosAgregados.splice(index, 1);
    renderizarProductos();
    actualizarResumen();
}

// Actualizar resumen cuando cambia el descuento
document.querySelector('#id_descuento').addEventListener('input', actualizarResumen);

// Validar formulario antes de enviar
document.getElementById('facturaForm').addEventListener('submit', function(e) {
    if (productosAgregados.length === 0) {
        e.preventDefault();
        alert('Debe agregar al menos un producto a la factura');
        return false;
    }
    
    // Validar que haya cliente o nombre de cliente
    const cliente = document.querySelector('#id_cliente').value;
    const clienteNombre = document.querySelector('#id_cliente_nombre').value.trim();
    
    if (!cliente && !clienteNombre) {
        e.preventDefault();
        alert('Debe seleccionar un cliente registrado o ingresar el nombre del cliente');
        return false;
    }
});
</script>
{% endblock %}
